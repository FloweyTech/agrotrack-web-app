<div class="plant-form-container">
  <h2>{{ 'PLANT_REGISTRATION.TITLE' | translate }}</h2>

  <!-- Formulario para agregar plantas individuales -->
  <form #plantForm="ngForm" (ngSubmit)="addPlantToSession()">
    <!-- Selector de Organización -->
    <div class="form-row">
      <label for="organization">{{ 'PLANT_REGISTRATION.ORGANIZATION' | translate }}</label>
      <select
        id="organization"
        name="organization"
        [value]="selectedOrganizationId() || ''"
        (change)="onOrganizationChange(+$any($event.target).value)"
        required
        [disabled]="loading()">
        <option value="">{{ 'PLANT_REGISTRATION.SELECT_ORGANIZATION' | translate }}</option>
        @for (org of activeOrganizations(); track org.organizationId) {
          <option [value]="org.organizationId">{{ org.organizationName }}</option>
        }
      </select>
      @if (loading()) {
        <small class="info-text">⏳ Cargando...</small>
      }
    </div>

    <!-- Selector de Parcela -->
    <div class="form-row">
      <label for="plot">{{ 'PLANT_REGISTRATION.PLOT' | translate }}</label>
      <select
        id="plot"
        name="plot"
        [value]="currentPlant.plotId || ''"
        (change)="currentPlant.plotId = +$any($event.target).value"
        required
        [disabled]="!selectedOrganizationId() || loading() || plots().length === 0">
        <option value="">{{ 'PLANT_REGISTRATION.SELECT_PLOT' | translate }}</option>
        @for (plot of plots(); track plot.plotId) {
          <option [value]="plot.plotId">{{ plot.plotName }}</option>
        }
      </select>
      @if (!selectedOrganizationId()) {
        <small class="info-text">⬆️ Primero seleccione una organización</small>
      }
      @if (selectedOrganizationId() && loading()) {
        <small class="info-text">⏳ Cargando parcelas...</small>
      }
      @if (selectedOrganizationId() && plots().length === 0 && !loading()) {
        <small class="info-text">{{ 'PLANT_REGISTRATION.NO_PLOTS_AVAILABLE' | translate }}</small>
      }
      @if (selectedOrganizationId() && plots().length > 0 && !loading()) {
        <small class="info-text">✅ {{ plots().length }} parcela(s) disponible(s)</small>
      }
    </div>

    <div class="form-row">
      <label for="height">{{ 'PLANT_REGISTRATION.HEIGHT' | translate }}</label>
      <input type="number" id="height" name="height" [(ngModel)]="currentPlant.height" required min="0" step="0.1">
    </div>
    <div class="form-row">
      <label for="leaves">{{ 'PLANT_REGISTRATION.LEAVES' | translate }}</label>
      <input type="number" id="leaves" name="leaves" [(ngModel)]="currentPlant.leaves" required min="0">
    </div>
    <div class="form-row">
      <label for="fruits">{{ 'PLANT_REGISTRATION.FRUITS' | translate }}</label>
      <input type="number" id="fruits" name="fruits" [(ngModel)]="currentPlant.fruits" required min="0">
    </div>
    <div class="form-row">
      <label for="date">{{ 'PLANT_REGISTRATION.DATE' | translate }}</label>
      <input type="date" id="date" name="date" [(ngModel)]="currentPlant.date" required>
    </div>
    <button type="submit" [disabled]="!plantForm.form.valid">{{ 'PLANT_REGISTRATION.ADD_TO_SESSION' | translate }}</button>
  </form>

  <!-- Lista de plantas en la sesión actual -->
  @if (sessionPlants.length > 0) {
    <div class="session-section">
      <h3>{{ 'PLANT_REGISTRATION.SESSION_PLANTS' | translate }} ({{ sessionPlants.length }})</h3>
      <div class="session-plants">
        @for (plant of sessionPlants; track plant.tempId!) {
          <div class="session-plant-item">
            <span>
              {{ 'PLANT_REGISTRATION.HEIGHT' | translate }}: {{ plant.height }}cm |
              {{ 'PLANT_REGISTRATION.LEAVES' | translate }}: {{ plant.leaves }} |
              {{ 'PLANT_REGISTRATION.FRUITS' | translate }}: {{ plant.fruits }} |
              {{ 'PLANT_REGISTRATION.DATE' | translate }}: {{ plant.date | date:'shortDate' }}
            </span>
            <button type="button" class="remove-btn" (click)="removeFromSession(plant.tempId!)">✕</button>
          </div>
        }
      </div>

      <div class="session-actions">
        <button type="button" (click)="calculateSessionAverage()">{{ 'PLANT_REGISTRATION.CALCULATE_AVERAGE' | translate }}</button>
        <button type="button" class="clear-btn" (click)="clearSession()">{{ 'PLANT_REGISTRATION.CLEAR_SESSION' | translate }}</button>
      </div>
    </div>
  }

  <!-- Card de promedio -->
  @if (sessionAverage) {
    <div class="average-card">
      <h4>{{ 'PLANT_REGISTRATION.AVERAGE_TITLE' | translate }}</h4>
      <p><strong>{{ 'PLANT_REGISTRATION.HEIGHT' | translate }}:</strong> {{ sessionAverage.height | number:'1.2-2' }} cm</p>
      <p><strong>{{ 'PLANT_REGISTRATION.LEAVES' | translate }}:</strong> {{ sessionAverage.leaves | number:'1.0-0' }}</p>
      <p><strong>{{ 'PLANT_REGISTRATION.FRUITS' | translate }}:</strong> {{ sessionAverage.fruits | number:'1.0-0' }}</p>
      <p><strong>{{ 'PLANT_REGISTRATION.PLANTS_COUNT' | translate }}:</strong> {{ sessionPlants.length }}</p>

      <div class="final-actions">
        <button type="button" class="save-session-btn" (click)="saveSession()">{{ 'PLANT_REGISTRATION.SAVE_SESSION' | translate }}</button>
      </div>
    </div>
  }
</div>
